---
title: "neophyte and red list analysis"
format: html
---

Load necessary libraries:
```{r}
library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)
```

Read combined data:
```{r}
data <- read_csv("../Daten/Intermediate/combined_data.csv")
data$`Species_unified_2004-23` <- sub(" cf\\.", "", data$`Species_unified_2004-23`)
data <- data[!endsWith(data$`Species_unified_2004-23`," spec."),]
data <- data[is.na(data$min_climax_dist) | data$min_climax_dist < 90 | data$min_fire_dist < 90,] # remove goedicke plots which are far away
taxon_conversion <- read_csv("../Daten/Intermediate/leuk_landolt_try_midolo_eive_taxon_conversion.csv")
landolt_data <- read_csv("../Daten/Landolt/2023-03-29_FI-export_Stefan_Widmer.csv")

taxon_conversion$landolt_taxa[startsWith(taxon_conversion$infoflora_taxon, "Salix")]
temp <- left_join(data, taxon_conversion, join_by(`Species_unified_2004-23` == infoflora_taxon))
complete_data <- left_join(temp, landolt_data, join_by(landolt_taxa == Taxon))
```

```{r}
unique(complete_data$`Species_unified_2004-23`[is.na(complete_data$EG)])
data_functional_group <- complete_data[!is.na(complete_data$EG),]
data_functional_group <- data_functional_group[data_functional_group$EG != '-',]
nrow(data_functional_group) / sum(data_functional_group$EG %in% c('1', '2', '3', '4', '5', '6', '7', '8'))


title <- "all altitudes"

create_functional_group_plot <- function(data, title) {
  data_functional_group <- distinct(data, year, global_id, `Species_unified_2004-23`, EG)

  tmp <- data_functional_group |> 
    select(year, global_id, EG) |>
    group_by(year, global_id) |>
    summarise(
      p_forest_plant = sum(EG == '1'),
      p_mountain_plant = sum(EG == '2'),
      p_low_elevation_pioneer = sum(EG == '3'),
      p_water = sum(EG == '4'),
      p_wetland = sum(EG == '5'),
      p_dry_meadow = sum(EG == '6'),
      p_ruderal = sum(EG == '7'),
      p_fertilized_meadow = sum(EG == '8')
    )
  
  plot <- pivot_longer(tmp, c("p_forest_plant", "p_mountain_plant", "p_low_elevation_pioneer", "p_water", "p_wetland", "p_dry_meadow", "p_ruderal", "p_fertilized_meadow")) |> ggplot(aes(fill=name, y=value, x=year)) + 
      geom_boxplot() +
      ggtitle(paste("number of plants in functional groups at ", title))
  ggsave(paste("../Daten/Results/FunctionalGroups/number_of_plants_in_functional_groups_at", title, ".png"), plot = plot)
  
  tmp <- data_functional_group |> 
    select(year, global_id, EG) |>
    group_by(year, global_id) |>
    summarise(
      p_forest_plant = 100 * sum(EG == '1') / length(global_id),
      p_mountain_plant = 100 * sum(EG == '2') / length(global_id),
      p_low_elevation_pioneer = 100 * sum(EG == '3') / length(global_id),
      p_water = 100 * sum(EG == '4') / length(global_id),
      p_wetland = 100 * sum(EG == '5') / length(global_id),
      p_dry_meadow = 100 * sum(EG == '6') / length(global_id),
      p_ruderal = 100 * sum(EG == '7') / length(global_id),
      p_fertilized_meadow = 100 * sum(EG == '8') / length(global_id)
    )
  
  plot <- pivot_longer(tmp, c("p_forest_plant", "p_mountain_plant", "p_low_elevation_pioneer", "p_water", "p_wetland", "p_dry_meadow", "p_ruderal", "p_fertilized_meadow")) |> ggplot(aes(fill=name, y=value, x=year)) + 
      geom_boxplot() +
      ggtitle(paste("% of plants in functional groups at ", title))
  ggsave(paste("../Daten/Results/FunctionalGroups/percent_plants_in_functional_groups_at", title, ".png"), plot = plot)
  
  
  tmp <- tmp |> 
    group_by(year) |>
    summarise(
      p_forest_plant = mean(p_forest_plant),
      p_mountain_plant = mean(p_mountain_plant),
      p_low_elevation_pioneer = mean(p_low_elevation_pioneer),
      p_water = mean(p_water),
      p_wetland = mean(p_wetland),
      p_dry_meadow = mean(p_dry_meadow),
      p_ruderal = mean(p_ruderal),
      p_fertilized_meadow = mean(p_fertilized_meadow)
    ) 
  
  tmp <- pivot_longer(tmp, c("p_forest_plant", "p_mountain_plant", "p_low_elevation_pioneer", "p_water", "p_wetland", "p_dry_meadow", "p_ruderal", "p_fertilized_meadow"))
  
  plot <- ggplot(tmp, aes(fill=name, y=value, x=year)) + 
      geom_bar(position="stack", stat="identity") +
      ggtitle(paste("% of plants in functional groups at ", title))
  ggsave(paste("../Daten/Results/FunctionalGroups/percent_plants_in_functional_groups_stacked_at", title, ".png"), plot = plot)
}

create_functional_group_plot(data_functional_group, "all altitudes")
create_functional_group_plot(data_functional_group[data_functional_group$altitude_band == "high",], "high altitudes")
create_functional_group_plot(data_functional_group[data_functional_group$altitude_band == "mid",], "mid altitudes")
create_functional_group_plot(data_functional_group[data_functional_group$altitude_band == "low",], "low altitudes")

```


